import { useState } from 'react';
import axios from 'axios';

function App() {
  const [image, setImage] = useState(null);

  async function logout(){
    try {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
    } catch (error) {
      console.log(error)
    }
  }

  async function login(){
    try{
      const response = await axios.post('http://localhost:3000/log-in',
                                    {username: 'poop', password: 'poop'},
                                    {
                                      headers: {
                                        'Content-Type': 'application/json',
                                      },
                                      withCredentials: true
                                    }
                                  )
      localStorage.setItem("token", response.data.token);
      localStorage.setItem("user", JSON.stringify(response.data.user));
    }catch(err){
      console.log(err)
    }
  }
  
  async function submitImage() {
    if(image){
      try {
        const formData = new FormData();
        formData.append('image', image);

        const token = localStorage.getItem('token');

        const response = await axios.post(
          'http://localhost:3000/user/65ad0b49fff6bfc935e2d2c5/conversations/65ad13226711e712987057b5/message/image',
          formData,
          {
            withCredentials: true,
            headers: {
              'Content-Type': 'multipart/form-data',
              'Authorization': `Bearer ${token}`,
            },
          }
        );

        console.log(response.data);
      } catch (err) {
        console.error(err);
      }
    }else{
      console.log('select image')
    }
  }

  const handleFileChange = (event) => {
    setImage(event.target.files[0]);
  };

  async function createConversation(){
    try {
      const recipientId = '65ad159dc6a6604ff1045c1a';

      const token = localStorage.getItem('token');
      if(token){
        const response = await axios.post(
          'http://localhost:3000/user/65ad0b49fff6bfc935e2d2c5/conversations',
          {
            recipient: recipientId,
          },
          {
            withCredentials: true,
            headers : {
              'Authorization': `Bearer ${token}`
            }
          }
        );
        console.log(response.data);
      }
    } catch (err) {
      console.error(err);
    }
    
    
      
  }
  return (
    <>
      <input type='file'  onChange={handleFileChange} />
      <button onClick={submitImage}>Submit</button>
      <button onClick={login}>Login</button>
      <button onClick={logout}>Logout</button>
      <button onClick={createConversation}>cONV</button>

      
    </>
  );
}

export default App;
